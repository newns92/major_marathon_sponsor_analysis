---
title: "Analysis"
output: html_document
---

```{r,warning=F,message=F}
library(tidyverse)
library(ggplot2)
library(RColorBrewer)
marathons <- read_rds('majorMarathons.Rda')
glimpse(marathons)
```

```{r cars}
glimpse(marathons)
```

## Including Plots

You can also embed plots, for example:

```{r, echo=FALSE}
marathons %>%
  filter(!is.na(country)) %>%
  group_by(country)%>%
  summarise(count = n()) %>%
  filter(count>10) %>%
  ggplot(aes(country,count)) + 
    geom_bar(stat="identity",colour="Black",fill="Blue") +
    theme_bw() +
    theme(axis.text.x = element_text(angle = 45, hjust = 1)) + 
    xlab("Country") + 
    ylab("Frequency") +
    ggtitle("Total Major Marathon Wins by Country")
```    
 
```{r}
 marathons %>%
  filter(!is.na(country)) %>%
  group_by(winner,country,gender)%>%
  summarise(count = n()) %>%
  arrange(desc(count))
```
US not a major marathon power, but bill rodgers most marathon major wins 
both top males = US + many wins @ boston (give atble)

top 2 females = norwat (waitz = 1st female < 2:30:00)

```{r pressure, echo=FALSE}
marathons %>%
  filter(!is.na(country),
         year>=1966) %>%
  group_by(country,gender) %>%
  summarise(count = n()) %>%
  arrange(desc(count)) %>%
  filter(count>5) %>%
  ggplot(aes(country,count)) + 
    geom_bar(aes(fill=gender),stat="identity",colour="Black",position="dodge") +
    theme_bw() +
    theme(axis.text.x = element_text(angle = 45, hjust = 1)) + 
    xlab("Country") + 
    ylab("Frequency") +
    ggtitle("Total Major Marathon Wins by Country")
```  

```{r}
 marathons %>%
  filter(!is.na(country),
         year>=1966) %>%
  group_by(marathon,gender)%>%
  summarise(count = n()) %>%
  arrange(desc(count))

#marathons %>%
#  filter(!is.na(country),
#         year>=1966) %>%
  #group_by(country,gender) %>%
  #summarise(count = n()) %>%
  #arrange(desc(count)) %>%
  #filter(count>5) %>%
  ggplot(marathons,aes(x=country)) + 
    geom_bar() + 
    coord_cartesian(ylim=c(30,115))
```
  aes(y = ..count.., fill=gender),stat="identity",colour="Black",
             position="dodge") +
    theme_bw() +
    theme(axis.text.x = element_text(angle = 45, hjust = 1)) + 
    xlab("Country") + 
    ylab("Frequency") +
    ggtitle("Total Major Marathon Wins by Country") + 
  facet_grid(.~marathon)


library(data.table)
mdt <- marathons %>%
  mutate(year=as.integer(year)) %>%
  as.data.table()
dcast.data.table(mdt, country ~ year,
                           fun.aggregate = count)

  
  
```{r}
filter(marathons,country=="Kenya")[which.min(filter(marathons,country=="Kenya")$year),]
```

# wins bykenya by year
marathons %>%
  filter(country %in% c("Kenya","Norway","Unites States","United Kingdom","Germany","Ethiopia","West Germany","Japan")) %>%
  group_by(country,year) %>%
  summarize(count = n()) %>%
  ggplot(aes(x=year,y=cumsum(count),group=country,color=country)) + 
    geom_freqpoly(stat = "identity") + 
  coord_cartesian(xlim=c(1985,2018))
#length(marathons$year)


```{r}
marathons %>% 
  group_by(country, year) %>%
  summarise(value = n()) %>%
  mutate(csum = cumsum(value)) %>%
  group_by(country) %>%
  summarise(n = max(csum)) %>%
  arrange(desc(n))
```

```{r, warning=F,message=FALSE}
marathons %>% 
  group_by(country, year) %>%
  summarise(value = n()) %>%
  #mutate(csum = cumsum(value)) %>%
  filter(country %in% c("Kenya","Norway","United States","United Kingdom","Germany","Ethiopia","West Germany","Japan")) %>%
  ggplot(aes(x=year,color=country)) +#,group=country,col=country)) +
    stat_bin(data=subset(marathons,country=="Kenya"),aes(y=cumsum(..count..)),geom="line",lwd=1.05)+
    stat_bin(data=subset(marathons,country=="Norway"),aes(y=cumsum(..count..)),geom="line",lwd=1.05)+
    stat_bin(data=subset(marathons,country=="Germany"),aes(y=cumsum(..count..)),geom="line",lwd=1.05)+
    stat_bin(data=subset(marathons,country=="West Germany"),aes(y=cumsum(..count..)),geom="line",lwd=1.05)+
    stat_bin(data=subset(marathons,country=="United Kingdom"),aes(y=cumsum(..count..)),geom="line",lwd=1.05)+
    stat_bin(data=subset(marathons,country=="Japan"),aes(y=cumsum(..count..)),geom="line",lwd=1.05)+
    stat_bin(data=subset(marathons,country=="United States"),aes(y=cumsum(..count..)),geom="line",lwd=1.05) +
    geom_point(aes(1967,37),size=3,color="purple") +  # bowerman = jogging
    geom_point(aes(1972,48),size=3,color="purple") +
    #geom_vline(xintercept=1972) +
    geom_text(aes(x=1950, label="Frank Shorter (1972)", y=90), colour="blue", angle=0,
              text=element_text(size=.25)) +
    #geom_vline(xintercept=1984) + 
    geom_point(aes(1984,90),size=3,color="purple") +
    geom_text(aes(x=2004, label="Joan Benoit (1984)", y=145), colour="red", angle=0,
              text=element_text(size=.25)) +
    theme_bw() +
    theme(axis.text.x = element_text(angle = 45, hjust = 1)) + 
    coord_cartesian(ylim=c(0,150)) + 
    xlab("Country") + 
    ylab("Frequency") +
    ggtitle("Total Major Marathon Wins by Country")
```
compare wiht olympics + world champs?

```{r}
marathons %>%
  filter(country %in% c("Kenya","Norway","United States","United Kingdom","Germany","Ethiopia","West Germany","Japan")) %>%
  ggplot(aes(country,time)) + 
    geom_jitter(aes(color = country),alpha=.6) +
    geom_boxplot(aes(fill = country),alpha=.2,outlier.colour = "black") +
    theme_bw() +
    theme(axis.text.x = element_text(angle = 45, hjust = 1)) + 
    xlab("Country") + 
    ylab("Frequency") +
    ggtitle("Total Major Marathon Wins by Country")
```

```{r,warning=F,message=F}
medianTime <- median(marathons$time,na.rm=T)

is_outlier <- function(x, na.rm=T) {
  return(x < quantile(x, 0.25) - 1.5 * IQR(x) | x > quantile(x, 0.75) + 1.5 * IQR(x))
}

marathons %>%
  filter(!is.na(time)) %>%
  mutate(outlier = ifelse(is_outlier(time), year, as.numeric(NA))) %>%
  ggplot(aes(marathon,time)) + 
    #geom_jitter(aes(color = marathon),alpha=.6) +
    geom_boxplot(aes(fill = marathon),alpha=.4, outlier.colour = "black",varwidth = T) +   
    coord_cartesian(ylim=c(as.POSIXct("2018-04-24 02:00:00"),as.POSIXct("2018-04-24 03:35:00"))) + 
    geom_text(aes(label = outlier), na.rm = TRUE, hjust = -0.3)
```
Outlieres in Bostoin + Berlin
```{r}
marathons %>%
  ggplot(aes(marathon,time)) + 
    #geom_jitter(aes(color = marathon),alpha=.6) +
    geom_boxplot(aes(fill = marathon),alpha=.4, outlier.shape = NA,varwidth = T) +   
    coord_cartesian(ylim=c(as.POSIXct("2018-04-24 02:00:00"),as.POSIXct("2018-04-24 03:00:00")))
```

closest to normal looks like tokyo (disproven by density)
all similar variance (height)
londong seems fastest (berling + chicago noted for it, but slightly older)

```{r}
marathons %>%
  ggplot(aes(time)) + 
  geom_histogram(bins=15,na.rm=T)
```

```{r, warning=F,message=F}
marathons %>%
  left_join(marathons %>%
    group_by(year) %>%
    summarize(minTime = min(time,na.rm=T)) %>%
    arrange(year),by = "year") %>%
  ggplot(aes(year,minTime)) + 
  geom_line() + 
  geom_smooth()
```

```{r}
marathons %>%
  ggplot(aes(time)) + 
  geom_density(aes(group=gender,fill=gender),alpha=.4)
```

```{r}
library(scales)
marathons %>%
  #filter(marathon %in% c("Berlin","Boston","Chicago")) %>%
  ggplot() + 
  stat_density(aes(x=time,y=..scaled..,fill=marathon),color="black") + 
  #geom_histogram(aes(fill=marathon),bins=15) +
  scale_fill_brewer(palette = "Set2") +
  facet_wrap(~marathon) + 
  guides(fill=F) + 
  theme(axis.text.x = element_text(angle = 90, hjust = 1))
  #scale_y_continuous() + 
```

Berlin + Chicago = going for time, why bimodal?

```{r}
marathons %>%
 # filter(marathon %in% c("NYC","London","Tokyo")) %>%
  ggplot(aes(year,time,color=marathon)) + 
  geom_smooth() + 
  #geom_smooth()
  facet_wrap(~marathon, scales = "free_x")
```

```{r}
marathons %>%
 # filter(marathon %in% c("NYC","London","Tokyo")) %>%
  ggplot(aes(year,time,color=marathon)) + 
  geom_smooth(se=F) + 
  #geom_smooth()
  facet_wrap(~marathon) +#, scales = "free_x") + 
  coord_cartesian(xlim=c(2007,2017),ylim = c(as.POSIXct("2018-04-24 02:00:00"),as.POSIXct("2018-04-24 02:25:00")))
          
```