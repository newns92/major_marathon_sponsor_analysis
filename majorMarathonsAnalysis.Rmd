---
title: "Analysis"
output: html_document
---

```{r,warning=F,message=F,echo=F}
library(tidyverse) # data manipulation
library(ggplot2) # plotting
library(RColorBrewer) # new ggplot colors
library(kableExtra) # "pretty" tables
library(scales) # reversing time y-axis values (https://groups.google.com/forum/#!topic/ggplot2/qrcvqy6TdzI)

marathons <- read_rds('majorMarathons.Rda')
#glimpse(marathons)
```

In wake of this year's Boston and London marathons (and their almost polar opposite conditions), there certainly was a lot of press over some historic wins:
 
 * Desi Linden becomeing the first American woamn wot win Boston since 1985
 * The "People's Champ" Yuki Kawauchi winning his first marathon major
 * Eluid Kipchoge further cementing himself as (in my opinion) the greatest marathoner ever, winning his 8th straight marathon, and his 9th out of a total of 10 (It's also important to note his only 2nd place was behind what ended up being a world record time).
 * Vivian Cheruiyot took the women's victory in London, taking advantage of the faltering of other elites such as Mary Keitany and Tirunesh Dibaba who were gunning for Paula Radcliffe's women's world record

After everything seemed to have settled down a bit, I thought it'd be fun to do a cursory analysis of the winners of the six current World Marathon Majors. 

## What are the World Marathon Majors?

The [World Marathon Majors (WMM)](https://www.worldmarathonmajors.com/) is a collection of six annual marathons: Tokyo, New York, Boston, London, Berlin, Chicago. And in the designated years, they also include the World Championship (held every 2 years by the IAAF) and the Olympic Marathon. The races are run as a series and the male and female athlete who score the most points from the qualifying races are crowned the champions of the series ("most points" is defined as the sum of points from a max of two of the qualifying races). For us non-elites, we can qualify as a **Six Star Finisher**, wherein after successfully completing all six of the WMM's, you can recieve an official certificate and Six Star Finisher Medal.

### EDA

After scraping Wikipedia for the past winners of the races and cleaning up the data (inclduing having to manually add the female winner for London 2018, Vivian Cheruiyot, since it still wasn't added over a week later, because Wikipedia?), I had a [nice data file](https://github.com/newns92/major_marathon_sponsor_analysis/blob/master/marathons.R) consisting of, for each race, the marathon, the winner, the year, the winner's gender, and the winner's time. A quick first plot to look at could be the count of WMM wins by country.

```{r wins by country, echo=F, message=F, warning=F, fig.align='center'}
marathons %>%
  filter(!is.na(country)) %>%
  group_by(country)%>%
  summarise(count = n()) %>%
  arrange(desc(count)) %>%
  top_n(n = 10) %>%
  ggplot(aes(country,count)) + 
    geom_bar(stat="identity",colour="Black",fill="Blue") +
    theme_bw() +
    theme(axis.text.x = element_text(angle = 45, hjust = 1)) + 
    xlab("Country") + 
    ylab("Wins") +
    ggtitle("Top 10 Countries in Total World Major Marathon Wins")
```    
  
The general consensus that Eastern Africa (i.e. Kenya and Ethiopa) is dominanting long distance running is clearly displayed in this plot, with countries with the next most wins being the United States, Germany, and the UK. It's pretty easy infer why, after Kenya and Ethiopia, these three countires have the most victories. Five of the six major marathons take place in these countries, which most likely results in a larger amount of runners from the host country paritciating relative to other countries, providing said home countries with more chances of producing the victor.But when did this domination by the East Africans begin?

```{r, warning=F,message=F,echo=F, fig.align='center'}
marathons %>% 
  group_by(country, year) %>%
  summarise(value = n()) %>%
  filter(country %in% c("Kenya","Norway","United States","United Kingdom","Germany","Ethiopia","Japan","Canada")) %>%
  ggplot(aes(x=year,color=country)) +
    stat_bin(data=subset(marathons,country=="Kenya"),aes(y=cumsum(..count..)),geom="line",lwd=1.05)+
    stat_bin(data=subset(marathons,country=="Norway"),aes(y=cumsum(..count..)),geom="line",lwd=1.05)+
    stat_bin(data=subset(marathons,country=="Germany"),aes(y=cumsum(..count..)),geom="line",lwd=1.05)+
    stat_bin(data=subset(marathons,country=="Ethiopia"),aes(y=cumsum(..count..)),geom="line",lwd=1.05)+
    stat_bin(data=subset(marathons,country=="United Kingdom"),aes(y=cumsum(..count..)),geom="line",lwd=1.05)+
    stat_bin(data=subset(marathons,country=="Japan"),aes(y=cumsum(..count..)),geom="line",lwd=1.05)+
    stat_bin(data=subset(marathons,country=="United States"),aes(y=cumsum(..count..)),geom="line",lwd=1.05) +
    stat_bin(data=subset(marathons,country=="Canada"),aes(y=cumsum(..count..)),geom="line",lwd=1.05) +
    scale_color_brewer(palette = "Dark2") +
   # geom_point(aes(1967,37),size=3,color="purple") +  # bowerman = jogging
    geom_point(aes(1971,49),size=3,color="#7e7e7e") +
    geom_text(aes(x=1955, label="Frank Shorter (1972)", y=50), colour="#7e7e7e", angle=0, size=3) +
    geom_point(aes(1983,90),size=3,color="#7e7e7e") +
    geom_text(aes(x=1968, label="Joan Benoit (1984)", y=90), colour="#7e7e7e", angle=0, size=3) +
    coord_cartesian(ylim=c(0,150),xlim=c(1890,2018)) +   
    scale_x_continuous(breaks=seq(1900, 2020, 20)) +   
    theme_bw() +
    theme(axis.text.x = element_text(angle = 45, hjust = 1)) + 
    xlab("Country") +
    ylab("Wins") +
    ggtitle("Total Major Marathon Wins by Country Over Time")
```

Noting the *incredibly important caveat* that Boston was the only marathon in the current WMM's that existed from its initial running in 1897 until the first running of the New York City Marathon in 1970, I believe it's safe to assume the fact that international travel was not as accessible and common in this time period is why only individuals from countries in close proximity to these races (i.e. US and Canada) saw their counts climb. This makes this chart pretty useless unless we cut down the time period that we are looking at. 

But, before leaving this chart completely, we can note that German and UK wins started picking up soon after the first couple of their respective marathons, with Berlin starting in 1974 and London in 1981, respectively. We can also note that, along with the establishment of the NYC Marathon in 1970, the number of US winners starts to climb much faster throughout the 1970's, thanks to the inclusion of women in the Boston and NYC marathons. The start of this spike also just barely predates Frank Shorter's gold medal at the 1972 Olympics, which is credidted as starting the running boom of the 1970's America, which is said to have culminated with Joan Benoit Samuelson's gold medal in the 1984 Olympics.

But now onto the limited time period:
```{r, warning=F,message=F,echo=F, fig.align='center'}
marathons %>% 
  group_by(country, year) %>%
  summarise(value = n()) %>%
  #mutate(csum = cumsum(value)) %>%
  filter(country %in% c("Kenya","Norway","United States","United Kingdom","Germany","Ethiopia","Japan","Canada")) %>%
  ggplot(aes(x=year,color=country)) +#,group=country,col=country)) +
    stat_bin(data=subset(marathons,country=="Kenya"),aes(y=cumsum(..count..)),geom="line",lwd=1.05)+
    stat_bin(data=subset(marathons,country=="Norway"),aes(y=cumsum(..count..)),geom="line",lwd=1.05)+
    stat_bin(data=subset(marathons,country=="Germany"),aes(y=cumsum(..count..)),geom="line",lwd=1.05)+
    stat_bin(data=subset(marathons,country=="Ethiopia"),aes(y=cumsum(..count..)),geom="line",lwd=1.05)+
    stat_bin(data=subset(marathons,country=="United Kingdom"),aes(y=cumsum(..count..)),geom="line",lwd=1.05)+
    stat_bin(data=subset(marathons,country=="Japan"),aes(y=cumsum(..count..)),geom="line",lwd=1.05)+
    stat_bin(data=subset(marathons,country=="United States"),aes(y=cumsum(..count..)),geom="line",lwd=1.05) +
    stat_bin(data=subset(marathons,country=="Canada"),aes(y=cumsum(..count..)),geom="line",lwd=1.05) +
    scale_color_brewer(palette = "Dark2") +
    geom_point(aes(1984,90),size=3,color="#7e7e7e") +
    geom_text(aes(x=1978, label="Joan Benoit ('84)", y=95), colour="#7e7e7e", angle=0, size=3) +
    geom_point(aes(2008,35),size=3,color="brown") +
    geom_text(aes(x=2006,y=43,label="Last UK Win ('08)"), colour="brown", angle=0, size=3) + 
    geom_point(aes(1983,2),size=3,color="green") +
    geom_text(aes(x=1983,y=-2,label="First Kenya Win"), colour="green", angle=0, size=3) + 
    coord_cartesian(xlim=c(1970,2018),ylim=c(0,150)) + 
  geom_vline(xintercept=2017) + 
    theme_bw() +
    theme(axis.text.x = element_text(angle = 45, hjust = 1)) + 
    xlab("Country") + 
    ylab("Frequency") +
    ggtitle("Total Major Marathon Wins by Country")
```

Here, we see that the first Kenyan winner was in 1983, but the country's rise in marathon victories did not kick-start until the mid-1990's. Ethiopia started a bit later, with their first victory in 1989 and their uptick in victories starting in early 2000's, Plateaus from other top countires, UK drough in 08 onways after 7 wins from Radcliffee over a 6 year span starting in 2002, gmernay having onyl 2 wins in past 20 yers, both in 08'

```{r, warning=F,message=F,echo=F, fig.align='center'}
 marathons %>%
  filter(!is.na(country)) %>%
  group_by(winner,country,gender)%>%
  summarise(count = n()) %>%
  arrange(desc(count)) %>%
  head(10) %>%
  kable()
```

We can see the dominant Grete Waitz (the first woman to run the marathon under 2:30:00, in NYC in 1979), who, along with fellow Norwegian Ingri Kristiansesn, make up the top 2 women and 2 of the top 3 overall. It also appears that although Kenya has many wins, they are more spread out, as we do not see a  Kenyan runner in the top 10 total wins until Catherine Nderebe. 


Rosa? check portual's overall statsuss

Current/ative = Kipchofe and Mary Keitany = current runners, 

```{r, warning=F,message=F,echo=F, fig.align='center'}
marathons %>%
  filter(winner %in% c("Bill Rodgers","Clarence DeMar","Grete Waitz","Ingrid Kristiansen","Paula Radcliffe")) %>%
  group_by(winner,marathon) %>%
  summarize(count = n()) %>%
  kable()
```

Here we see some the dominance of Grete Waitz at NYC, and the fact that every single marathon major win by Clarence DeMar was in Boston, while Bill "Boston Billy" Rodgers actually split his majors wins between NYC and Boston. Radcliffe split between home crowd of London (WR) and NYC 

top us not so successful internationally

Going back to the initial wins by country bar chart, we can split it by gender, filtered down to years in which both men and women competed for a clearer picture.

```{r , warning=F,message=F,echo=F, fig.align='center'}
marathons %>%
  filter(!is.na(country),
         year>=1981) %>%
  group_by(country,gender) %>%
  summarise(count = n()) %>%
  arrange(desc(count)) %>%
  filter(count>5) %>%
  ggplot(aes(country,count)) + 
    geom_bar(aes(fill=gender),stat="identity",colour="Black",position="dodge") +
    scale_fill_manual("Gender", values = c("Male" = "blue", "Female" = "Red")) +
    theme_bw() +
    theme(axis.text.x = element_text(angle = 45, hjust = 1)) + 
    xlab("Country") + 
    ylab("Frequency") +
    ggtitle("Total Major Marathon Wins by Country by Gender")
```  

Kenya still dominantes, having the most males + females winners, while the female runners of Ehtiopsa have performed better htan the males. Many counties hae female only winners (such as the dominance of Waitz and Kristiansen for and Pippig for Germany, while MEX and BRAZ only malw winners. UK + US split on gender

### Time

```{r, warning=F,message=F,echo=F, fig.align='center'}
c_trans <- function(a, b, breaks = b$breaks, format = b$format) {
  a <- as.trans(a)
  b <- as.trans(b)

  name <- paste(a$name, b$name, sep = "-")

  trans <- function(x) a$trans(b$trans(x))
  inv <- function(x) b$inverse(a$inverse(x))

  trans_new(name, trans, inv, breaks, format)
}

rev_date <- c_trans("reverse", "time")

marathons %>%
  filter(country %in% c("Kenya","Norway","United States","United Kingdom","Germany","Ethiopia","Japan","Canada")) %>%
  ggplot(aes(country,time)) + 
    #geom_jitter(aes(color = country),alpha=.6) +
    geom_boxplot(aes(fill = country),alpha=.5,outlier.colour = "black",varwidth = T) +
    scale_fill_brewer(palette = "Dark2") +
    theme_bw() +
    theme(axis.text.x = element_text(angle = 45, hjust = 1)) + 
    xlab("Country") + 
    ylab("Frequency") +
    ggtitle("Total Major Marathon time by Country") + 
    guides(fill=F) + 
    scale_y_continuous(trans = rev_date)
```

US variability was predictiable to be as its beens it has Boston ahs longset runninga n marathon times have dropped as years have gone by. Germany's wide variance is something to note I wuoldhtink, since Berlin is known as a faster course. This could definitely be something to look futher into. Norway and Canada both have very little variabliity in winning times, and coincidentally have one slow and one fast outlier, albeint with with lower sample sizes than Kenya, US. Norway also appears ot be a bit skewed, with its median winnign time being more towards the 3rd quartile. The US has the slowest outliers, ignoring the one german one. But Kenya's dominance contiues with fastes median win eimte, (wiht a skew) while UK and Japan both seem sto be faster than Ehtiopoa, but Ethipoua just has hasppned to win more.


```{r, warning=F,message=F,echo=F, fig.align='center'}
medianTime <- median(marathons$time,na.rm=T)

marathons %>%
  filter(!is.na(time)) %>%
  ggplot(aes(marathon,time)) + 
    geom_boxplot(aes(fill = marathon),alpha=.4, outlier.colour = "black",varwidth = T) +   
    coord_cartesian(ylim=c(as.POSIXct(paste(Sys.Date(),"02:00:00")),as.POSIXct(paste(Sys.Date(),"03:35:00")))) + 
    guides(fill=F) + 
    theme_bw() + 
    scale_y_continuous(trans = rev_date)
```

Boston slwo confirming US outliers + variabliity, chicaho bretty slow, Berlin used to be slow? Londong fastet, followed by Chicago. Overall pretty even.. Cut down on outlerus

```{r, warning=F,message=F,echo=F, fig.align='center'}
marathons %>%
  filter(!is.na(time)) %>%
  ggplot(aes(marathon,time)) + 
    geom_boxplot(aes(fill = marathon),alpha=.4, outlier.shape = NA,varwidth = T) +   
    coord_cartesian(ylim=c(as.POSIXct(paste(Sys.Date(),"02:00:00")),as.POSIXct(paste(Sys.Date(),"03:00:00")))) + 
    guides(fill=F) + 
    theme_bw() + 
    scale_y_continuous(trans = rev_date)
```

closest to normal looks like tokyo (disproven by density)
all similar variance (height)
londong seems fastest (berling + chicago noted for it, but slightly older)
all between 2:10-2:30

Let's look at histogram of all times

```{r, warning=F,message=F,echo=F, fig.align='center'}
marathons %>%
  filter(!is.na(time)) %>%
  ggplot(aes(time)) + 
  geom_histogram(bins=125,na.rm=T,fill="blue",) + 
  coord_cartesian(xlim=c(as.POSIXct(paste(Sys.Date(),"02:00:00")),as.POSIXct(paste(Sys.Date(),"03:00:00")))) + 
  theme_bw()
```

Bimodal, expecting du eto gender. with majory of wining times being in the mid 2:20's (probs women) and lower 2:10's (probs men)

```{r, warning=F,message=F,echo=F, fig.align='center'}
marathons %>%
  filter(!is.na(time)) %>%
  ggplot(aes(time)) + 
  geom_density(aes(group=gender,fill=gender),alpha=.4) + 
  scale_fill_manual("Gender", values = c("Male" = "blue", "Female" = "Red")) + 
  theme_bw()
```

Confirming above hyptheis, both v. right-skewed

```{r, warning=F,message=F,echo=F, fig.align='center'}
marathons %>%
  filter(!is.na(time)) %>%
  left_join(marathons %>%
    group_by(year) %>%
    summarize(minTime = min(time,na.rm=T)) %>%
    arrange(year),by = "year") %>%
  ggplot(aes(year,minTime)) + 
  geom_line() + 
  geom_smooth() +
  coord_cartesian(ylim=c(as.POSIXct(paste(Sys.Date(),"01:45:00")),as.POSIXct(paste(Sys.Date(),"03:00:00")))) + 
  theme_bw()
```

Slow and steady fastest times by year, coming to almost a standstill in the 80's

```{r, warning=F,message=F,echo=F, fig.align='center'}
marathons %>%
  filter(!is.na(time)) %>%
  left_join(marathons %>%
              group_by(year,gender) %>%
              summarize(minTime = min(time,na.rm=T)) %>%
              arrange(year),by = c("year","gender")) %>%
  select(year,gender,minTime) %>%
  filter(!is.na(gender),year>=1966) %>%
  ggplot(aes(year,minTime)) + 
    geom_line(aes(colour=gender)) +
    scale_color_manual("Gender", values = c("Male" = "blue", "Female" = "Red")) + 
    facet_grid(~gender) +
    guides(fill=F) +
    theme_bw()
    
    
```

Again filtering down to allowing women to start, the start quite slow, but have a remarkably quick drop in times between 1970 and 1980 before returning to a pattern resembling the men's of a slow decline

```{r, warning=F,message=F,echo=F, fig.align='center'}
marathons %>%
  filter(!is.na(time)) %>%
  ggplot() + 
    stat_density(aes(x=time,y=..scaled..,fill=marathon),color="black") + 
    scale_fill_brewer(palette = "Set2") +
    facet_wrap(~marathon) + 
    guides(fill=F) + 
    theme(axis.text.x = element_text(angle = 90, hjust = 1)) + 
    theme_bw()
```



```{r, warning=F,message=F,echo=F, fig.align='center'}
marathons %>%
  filter(!is.na(time)) %>%
  ggplot() + 
    geom_density(aes(x=time,y=..scaled..,group=gender,fill=gender),alpha=.4) + 
    scale_fill_manual("Gender", values = c("Male" = "blue", "Female" = "Red")) +
    facet_wrap(~marathon) + 
    guides(fill=F) + 
    theme_bw() + 
    theme(axis.text.x = element_text(angle = 90, hjust = 1))
```
all quite similar except Boston having its slow males in early years. Look at when all men + women allowed

```{r, warning=F,message=F,echo=F, fig.align='center'}
marathons %>%
  filter(!is.na(country),
         year>=1981) %>%
  ggplot() + 
    geom_density(aes(x=time,y=..scaled..,group=gender,fill=gender),alpha=.4) + 
    scale_fill_manual("Gender", values = c("Male" = "blue", "Female" = "Red")) +
    facet_wrap(~marathon) + 
    guides(fill=F) + 
    theme_bw() + 
    theme(axis.text.x = element_text(angle = 90, hjust = 1))
```

Boston + NYC very tight densities around similar times, Tokyo males quite consistent, Berin, CHI, Londong quite similar, 

```{r, warning=F,message=F,echo=F, fig.align='center'}
marathons %>%
  filter(!is.na(time)) %>%
  ggplot(aes(year,time,color=marathon)) + 
    geom_smooth() + 
    scale_fill_brewer(palette = "Set2") +
    facet_wrap(~marathon, scales = "free_x") +
    theme(legend.position="none") +
    theme_bw()
```

Tokyo's infancy = more variabliieyt, Berling consistent decrase, Londong quite steady with slight decrease, NYC steep drop to steayd, chicaho slowly deceaset, Boston has slight upticks in 60's and now

Look at all since inception of Tokyo: 
```{r, warning=F,message=F,echo=F, fig.align='center'}
marathons %>%
  filter(!is.na(time)) %>%
  ggplot(aes(year,time,color=marathon)) + 
    geom_smooth(se=F) + 
    theme_bw() + 
    facet_wrap(~marathon) +
    coord_cartesian(xlim=c(2007,2018),
                    ylim = c(as.POSIXct(paste(Sys.Date(),"02:00:00")),as.POSIXct(paste(Sys.Date(),"02:25:00"))))
```

London quite the same, BARELY going down, Berling slowly going down, NYC + Chicaco v. similar in keeping steay with BARELY increase, Bostong acutally getting lsower, TOkyo goign down faster in this smaller window, maybe due to it's "newness" just starting to attract the top talent to race